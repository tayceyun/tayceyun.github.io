要将这份**多周期+技术指标+基本面共振**的分析思路，固化为可定期复盘的**标准化分析框架**，核心是**拆解逻辑→制作模板→固定流程→动态优化**。以下是分步骤落地指南，直接可执行：

# 一、核心逻辑拆解：复盘框架的底层支柱
先明确框架的**4大核心模块**，确保每次复盘不遗漏关键维度，这是从报告中提炼的核心逻辑：
1. **关键压力/支撑位确认**：聚焦长期趋势线（如6124-5178）、整数关口、均线系统，明确当期核心多空分水岭。
2. **多周期技术共振分析**：日线、周线、月线、年线（根据复盘频率选择，如周复盘可选日/周/月）的**趋势、形态、指标**同步验证。
3. **量价与资金面验证**：成交量配合度、北向资金、两融、公募基金等资金流向，确认技术信号的有效性。
4. **基本面与政策面共振**：宏观经济、行业景气、政策动向，验证技术趋势是否有基本面支撑，避免纯技术面误判。

# 二、制作标准化复盘模板（核心步骤，附模板框架）
模板是固化思路的关键，分为**基础信息、核心分析、结论与操作**三大板块，以下是可直接套用的框架：

## 【模板名称】A股市场多周期共振定期复盘表
### 1. 基础信息（每次复盘必填，5分钟完成）
| 项目 | 内容 | 备注 |
|------|------|------|
| 复盘周期 | □ 日复盘 □ 周复盘 □ 月复盘 □ 季度/年度复盘 | 明确周期，对应不同分析粒度 |
| 当期市场核心指数 | 上证综指/沪深300/创业板指 收盘点位、涨跌幅 | 聚焦1-2个核心指数，避免分散 |
| 当期关键时间节点 | 节假日/政策窗口期/财报季/外部事件（如美联储议息） | 标注可能影响市场的特殊节点 |

### 2. 核心分析模块（复盘核心，按逻辑顺序填写）
#### 模块1：关键压力/支撑位确认（长期趋势锚定）
1. **长期趋势线**：计算当期6124-5178压力线位置（公式：基准点 + 斜率×时间跨度），确认指数与压力线的相对位置（□ 站上方 □ 下方震荡 □ 测试支撑）。
2. **短期关键位置**：当期核心压力位（如3970）、支撑位（如3900），来源：均线（MA5/MA10/MA60）、前期高低点、整数关口。
3. **结论**：当期多空分水岭是______，指数处于______（强势/中性/弱势）区间。

#### 模块2：多周期技术共振分析（核心，按周期拆解）
**选择与复盘周期匹配的周期组合**：
- 日复盘：日线+周线+月线
- 周复盘：周线+月线+季线
- 月/年度复盘：月线+季线+年线

| 周期 | 趋势判断（K线形态/均线排列） | 核心技术指标（MACD/RSI/布林带） | 信号结论（□ 多头 □ 空头 □ 震荡） |
|------|--------------------------------|----------------------------------|------------------------------------|
| 短周期（如日线） | 例：11连阳，MA5/MA10多头排列 | 例：MACD金叉，RSI 78（超买） | 例：短期强势，存在调整压力 |
| 中周期（如周线） | 例：二连阳，突破前期震荡平台 | 例：MACD绿柱缩短，即将金叉 | 例：中期趋势向上，确认短期强势 |
| 长周期（如月线） | 例：阳包阴，站稳MA5 | 例：MACD零轴上金叉，红柱延长 | 例：长期趋势向好，多周期共振 |
| **多周期共振结论** | ① 是否存在多周期同步信号（□ 是 □ 否）；② 主导周期是______ |

#### 模块3：量价与资金面验证（技术信号有效性确认）
1. **成交量**：当期日均成交额 vs 近1个月均值（□ 放大 □ 萎缩 □ 持平），突破压力位时是否放量（□ 是 □ 否）。
2. **资金流向**：
   - 北向资金：当期净买入/卖出额，近10日趋势（□ 流入 □ 流出）。
   - 两融余额：当期变化量，杠杆资金是否加仓（□ 是 □ 否）。
   - 公募基金：新发基金规模、仓位变化（□ 加仓 □ 减仓）。
3. **结论**：量价/资金是否验证技术信号（□ 是 □ 否 □ 部分验证）。

#### 模块4：基本面与政策面共振（趋势持续性验证）
1. **宏观经济**：当期PMI/CPI/GDP增速，经济处于______（复苏/过热/滞胀/衰退）阶段。
2. **行业景气**：领涨/领跌行业的景气度（如科技板块的AI进展、消费板块的复苏数据）。
3. **政策动向**：当期核心政策（如货币政策降准降息、产业政策支持新质生产力），对市场的影响（□ 利好 □ 利空 □ 中性）。
4. **结论**：基本面/政策是否支撑技术趋势（□ 是 □ 否 □ 中性）。

### 3. 结论与操作建议（复盘输出，指导投资行动）
1. **当期市场核心判断**：技术面______，资金面______，基本面______，整体处于______（趋势性上涨/震荡/趋势性下跌）。
2. **关键风险点**：短期超买/获利盘回吐/外资流出/政策不及预期等。
3. **操作策略**：
   - 仓位建议：______成仓（如7-8成）。
   - 板块配置：______（如均衡配置科技成长与价值蓝筹）。
   - 止盈止损：压力位______（止盈），支撑位______（止损）。
4. **下期关注重点**：如3970点是否站稳、北向资金是否持续流入、政策落地情况等。

# 三、固定复盘流程（形成习惯，确保执行）
1. **确定复盘频率**：根据投资风格固定频率，避免随意性：
   - 短线投资者：日复盘（15分钟）+ 周复盘（30分钟）。
   - 中线投资者：周复盘（30分钟）+ 月复盘（1小时）。
   - 长线投资者：月复盘（1小时）+ 季度/年度复盘（2小时）。
2. **固定复盘时间**：如日复盘在收盘后30分钟，周复盘在周日晚上，月复盘在月末最后一个交易日收盘后。
3. **执行步骤**：
   ① 填写基础信息（5分钟）；
   ② 计算关键压力/支撑位（10分钟）；
   ③ 多周期技术分析（20分钟）；
   ④ 量价/资金面验证（10分钟）；
   ⑤ 基本面/政策面分析（15分钟）；
   ⑥ 输出结论与操作建议（10分钟）。
4. **存档与对比**：每次复盘后将模板存档，标注日期，便于后续对比历史走势，验证框架的有效性。

# 四、动态优化框架（持续迭代，适配市场变化）
市场风格会变化（如从成长股到价值股，从技术牛到基本面牛），框架需要**定期优化**，避免僵化：
1. **优化频率**：每季度/每半年一次，或当市场出现重大风格切换时（如2025年科技股领涨）。
2. **优化内容**：
   - **指标调整**：如当MACD失效时，可加入KDJ、布林带等其他指标；
   - **周期调整**：如市场进入震荡市，可增加60分钟线等短周期分析；
   - **基本面维度**：如当政策成为核心驱动时，可增加政策力度评分维度；
   - **风险因子**：如当外资成为主导资金时，可增加美元指数、美债收益率等外部风险因子。
3. **验证效果**：用历史数据回测优化后的框架，看是否能提高判断准确率，再应用到实盘复盘。

# 五、关键注意事项（避免框架失效的核心要点）
1. **一致性优先**：同一指标的计算方法、周期划分必须保持一致（如压力线的斜率计算、RSI的参数设置），否则历史数据不可比。
2. **共振优先于单一信号**：复盘的核心是“多维度共振”，如技术面多头+资金面流入+基本面向好，才是强信号；单一维度信号（如仅日线连阳）需谨慎对待。
3. **操作与结论绑定**：复盘的最终目的是指导操作，避免“分析一套，操作一套”，需严格按照结论中的仓位、止盈止损执行。
4. **不追求完美**：框架是工具，不是万能的，允许一定的误判率，重点是通过持续复盘形成稳定的投资逻辑，而非精准预测每一次波动。

### 交付物提议
作为软件开发人员，你可以将这套**多周期共振分析逻辑**，通过**代码工程化**实现**智能化复盘系统**。核心思路是：**数据自动化采集 → 指标程序化计算 → 信号智能化生成 → 报告自动化输出**，同时保留可扩展性，适配市场变化。

以下是分阶段的**技术实现方案**，从最小可行产品（MVP）到全功能系统，你可以按需迭代：

# 一、核心架构设计（分层架构，高内聚低耦合）
整个系统分为5层，每层职责清晰，便于开发和维护：
| 层级 | 核心功能 | 技术选型建议 |
|------|----------|--------------|
| **数据层** | 自动采集指数K线、资金流向、基本面、政策等数据 | Tushare/akshare（免费）、Wind（付费）、聚宽JoinQuant（回测） |
| **计算层** | 计算趋势线、技术指标（MACD/RSI）、多周期信号、共振评分 | Python（Pandas/Numpy）、量化库（TA-Lib/Backtrader） |
| **信号层** | 基于规则生成多周期信号、共振信号、风险预警信号 | 自定义规则引擎（if-elif/配置文件）、轻量级机器学习（可选） |
| **输出层** | 自动生成复盘报告（Markdown/Excel/HTML）、可视化图表 | Matplotlib/Plotly（可视化）、Jinja2（模板引擎） |
| **交互层** | 定时任务触发、参数配置、结果查询 | FastAPI（接口）、Vue/React（前端，可选）、Airflow（定时任务） |

# 二、MVP阶段实现（最快落地，1-2周完成）
先实现核心功能：**自动采集数据 → 计算关键指标 → 生成共振信号 → 输出简易报告**，技术栈优先选你熟悉的（如Python+Pandas）。

## 1. 数据层：自动化数据采集
核心是获取**指数K线数据**（日/周/月/年线）、**资金流向数据**（北向、两融）。
- **免费数据源**：
  - Tushare Pro：获取上证指数、沪深300等指数的K线数据（需要token，免费额度足够个人使用）。
  - akshare：获取北向资金、两融余额、宏观经济数据（如PMI）。
- **核心代码示例**（Python）：
  ```python
  import tushare as ts
  import akshare as ak

  # Tushare初始化
  ts.set_token("你的Tushare Token")
  pro = ts.pro_api()

  # 获取上证指数日K线（复权）
  def get_index_kline(ts_code="000001.SH", freq="D", start_date="20200101", end_date=None):
      """
      freq: D=日, W=周, M=月, Y=年
      """
      if freq == "D":
          df = pro.index_daily(ts_code=ts_code, start_date=start_date, end_date=end_date)
      elif freq == "W":
          df = pro.index_weekly(ts_code=ts_code, start_date=start_date, end_date=end_date)
      elif freq == "M":
          df = pro.index_monthly(ts_code=ts_code, start_date=start_date, end_date=end_date)
      # 转换时间格式，排序
      df["trade_date"] = pd.to_datetime(df["trade_date"])
      df = df.sort_values("trade_date").reset_index(drop=True)
      return df

  # 获取北向资金当日数据
  def get_north_money(date):
      north_df = ak.stock_em_hsgt_north_flow_hist(date=date)
      return north_df.iloc[0]["北向资金当日净买入(亿元)"]
  ```

## 2. 计算层：指标程序化计算
核心是实现**趋势线计算**（如6124-5178压力线）、**技术指标计算**（MACD/RSI）、**多周期趋势判断**。
- **趋势线计算**：通过线性回归拟合历史高点（6124.04, 2007-10-16）和（5178.19, 2015-06-12），得到斜率和截距，从而计算任意日期的压力线位置。
  ```python
  from scipy import stats
  import pandas as pd

  # 历史高点数据（时间戳转数值，方便回归）
  high_points = [
      (pd.Timestamp("2007-10-16").timestamp(), 6124.04),
      (pd.Timestamp("2015-06-12").timestamp(), 5178.19)
  ]
  x = [p[0] for p in high_points]
  y = [p[1] for p in high_points]

  # 线性回归计算斜率和截距
  slope, intercept, r_value, p_value, std_err = stats.linregress(x, y)

  # 计算任意日期的压力线位置
  def calculate_pressure_line(date):
      date_timestamp = pd.Timestamp(date).timestamp()
      return slope * date_timestamp + intercept
  ```
- **技术指标计算**：使用TA-Lib库快速计算MACD、RSI、均线等指标，避免重复造轮子。
  ```python
  import talib

  def calculate_tech_indicators(df):
      # 均线：MA5, MA10, MA60
      df["ma5"] = talib.MA(df["close"], timeperiod=5)
      df["ma10"] = talib.MA(df["close"], timeperiod=10)
      df["ma60"] = talib.MA(df["close"], timeperiod=60)
      
      # MACD
      df["macd"], df["macdsignal"], df["macdhist"] = talib.MACD(df["close"], fastperiod=12, slowperiod=26, signalperiod=9)
      
      # RSI
      df["rsi"] = talib.RSI(df["close"], timeperiod=14)
      
      return df
  ```
- **多周期趋势判断**：对每个周期（日/周/月），根据K线形态、均线排列、指标生成**多头/空头/震荡**信号。
  ```python
  def get_trend_signal(df, freq):
      """
      df: 某一周期的K线数据（已计算指标）
      freq: 周期类型（D/W/M/Y）
      return: signal（1=多头，0=震荡，-1=空头）
      """
      latest = df.iloc[-1]
      signal = 0
      
      # 均线多头排列：MA5 > MA10 > MA60
      if latest["ma5"] > latest["ma10"] > latest["ma60"]:
          signal += 1
      # MACD金叉：macd > macdsignal 且 红柱放大
      if latest["macd"] > latest["macdsignal"] and latest["macdhist"] > 0:
          signal += 1
      # RSI未超买超卖：30 < rsi < 70
      if 30 < latest["rsi"] < 70:
          signal += 0
      else:
          signal -= 1
      
      # 综合判断
      if signal >= 2:
          return 1  # 多头
      elif signal <= 0:
          return -1  # 空头
      else:
          return 0  # 震荡
  ```

## 3. 信号层：智能化共振信号生成
核心是**多周期信号共振**（如日线多头+周线多头+月线多头）、**量价资金共振**（如突破压力位+放量+北向流入），通过**评分系统**量化信号强度。
- **共振评分规则**（可配置化，通过JSON文件管理）：
  ```json
  {
      "multi_cycle": {
          "daily_signal": 1,
          "weekly_signal": 2,
          "monthly_signal": 3
      },
      "volume_money": {
          "break_pressure": 2,
          "volume_amplify": 1,
          "north_inflow": 1
      },
      "fundamental": {
          "pmi_up": 1,
          "policy_bullish": 2
      }
  }
  ```
- **核心代码示例**：
  ```python
  def calculate_resonance_score(cycle_signals, volume_money_factors, fundamental_factors):
      """
      cycle_signals: 多周期信号字典 {"daily":1, "weekly":1, "monthly":1}
      volume_money_factors: 量价资金因子列表 [True, True, True]
      fundamental_factors: 基本面因子列表 [True, True]
      return: 总评分，信号强度（强/中/弱）
      """
      # 加载评分规则（从JSON文件）
      with open("score_rule.json", "r") as f:
          rule = json.load(f)
      
      # 多周期得分
      cycle_score = 0
      for freq, signal in cycle_signals.items():
          if signal == 1:
              cycle_score += rule["multi_cycle"][f"{freq}_signal"]
      
      # 量价资金得分
      vm_score = 0
      factors = ["break_pressure", "volume_amplify", "north_inflow"]
      for i, factor in enumerate(factors):
          if volume_money_factors[i]:
              vm_score += rule["volume_money"][factor]
      
      # 基本面得分
      fund_score = 0
      factors = ["pmi_up", "policy_bullish"]
      for i, factor in enumerate(factors):
          if fundamental_factors[i]:
              fund_score += rule["fundamental"][factor]
      
      total_score = cycle_score + vm_score + fund_score
      
      # 信号强度判断
      if total_score >= 8:
          return total_score, "强多头"
      elif total_score >= 5:
          return total_score, "中多头"
      elif total_score <= -3:
          return total_score, "强空头"
      else:
          return total_score, "震荡"
  ```

## 4. 输出层：自动化报告与可视化
核心是**基于模板引擎**生成Markdown/HTML复盘报告，**基于可视化库**生成K线图、指标图、共振评分图。
- **报告模板**（使用Jinja2模板引擎，Markdown格式）：
  ```markdown
  # A股多周期共振复盘报告
  **复盘日期**：{{ report_date }}
  **核心指数**：{{ index_code }}（{{ close_price }}，{{ change_rate }}%）

  ## 一、关键压力/支撑位
  - 6124-5178压力线位置：{{ pressure_line }}
  - 当期压力位：{{ current_pressure }}
  - 当期支撑位：{{ current_support }}
  - 指数位置判断：{{ position_judgment }}

  ## 二、多周期信号
  | 周期 | 趋势信号 | 技术指标摘要 |
  |------|----------|--------------|
  | 日线 | {{ daily_signal }} | MACD: {{ macd_status }}, RSI: {{ rsi_value }} |
  | 周线 | {{ weekly_signal }} | {{ weekly_indicator_summary }} |
  | 月线 | {{ monthly_signal }} | {{ monthly_indicator_summary }} |

  ## 三、共振评分与信号强度
  - 总评分：{{ total_score }}
  - 信号强度：{{ signal_strength }}
  - 核心共振因子：{{ core_factors }}

  ## 四、操作建议
  - 仓位建议：{{ position_suggestion }}
  - 板块配置：{{ sector_suggestion }}
  - 止盈止损：{{ stop_profit_loss }}
  - 下期关注重点：{{ next_focus }}
  ```
- **可视化代码示例**（使用Plotly生成交互式K线图，叠加压力线和指标）：
  ```python
  import plotly.graph_objects as go
  from plotly.subplots import make_subplots

  def generate_kline_chart(df, pressure_line):
      # 创建子图：K线图 + MACD + RSI
      fig = make_subplots(rows=3, cols=1, shared_xaxes=True, 
                          row_heights=[0.5, 0.25, 0.25])
      
      # K线图
      fig.add_trace(go.Candlestick(x=df["trade_date"],
                                   open=df["open"], high=df["high"],
                                   low=df["low"], close=df["close"],
                                   name="K线"), row=1, col=1)
      # 压力线
      fig.add_trace(go.Scatter(x=df["trade_date"], y=[pressure_line]*len(df),
                               name="压力线", line=dict(color="red", dash="dash")),
                    row=1, col=1)
      
      # MACD
      fig.add_trace(go.Bar(x=df["trade_date"], y=df["macdhist"], name="MACD Hist"),
                    row=2, col=1)
      fig.add_trace(go.Scatter(x=df["trade_date"], y=df["macd"], name="MACD"),
                    row=2, col=1)
      fig.add_trace(go.Scatter(x=df["trade_date"], y=df["macdsignal"], name="Signal"),
                    row=2, col=1)
      
      # RSI
      fig.add_trace(go.Scatter(x=df["trade_date"], y=df["rsi"], name="RSI"),
                    row=3, col=1)
      fig.add_hline(y=70, line_dash="dash", line_color="red", row=3, col=1)
      fig.add_hline(y=30, line_dash="dash", line_color="green", row=3, col=1)
      
      fig.update_layout(title="上证指数多周期分析图", height=800)
      fig.write_html("kline_analysis.html")
      return fig
  ```

## 5. 定时任务：自动化触发复盘
使用**APScheduler**（轻量级）或**Airflow**（分布式）实现定时任务，如：
- 日复盘：每日收盘后30分钟触发；
- 周复盘：每周日20:00触发；
- 月复盘：每月最后一个交易日收盘后触发。
- **核心代码示例**（APScheduler）：
  ```python
  from apscheduler.schedulers.blocking import BlockingScheduler

  def daily_review():
      # 执行日复盘逻辑
      print("开始日复盘...")
      # 1. 采集数据
      # 2. 计算指标
      # 3. 生成信号
      # 4. 输出报告
      print("日复盘完成！")

  if __name__ == "__main__":
      scheduler = BlockingScheduler()
      # 每日收盘后30分钟（15:30）触发日复盘
      scheduler.add_job(daily_review, "cron", hour=15, minute=30)
      # 每周日20:00触发周复盘
      scheduler.add_job(weekly_review, "cron", day_of_week=6, hour=20)
      scheduler.start()
  ```

# 三、进阶优化方向（MVP之后的迭代路径）
1. **可配置化规则引擎**
   - 将趋势判断、共振评分、操作建议等规则，从代码中抽离到**配置文件**（JSON/YAML）或**数据库**中，无需修改代码即可调整规则。
   - 示例：新增一个技术指标（如布林带），只需在配置文件中添加指标参数和评分规则，系统自动加载计算。

2. **机器学习增强信号**
   - 基于历史数据，训练**分类模型**（如逻辑回归、随机森林），预测多周期共振信号的胜率，优化评分规则。
   - 示例：用过去5年的历史数据，输入多周期信号、量价因子、基本面因子，输出“上涨/下跌/震荡”标签，训练模型后，用模型输出辅助人工判断。

3. **前端交互界面**
   - 使用**FastAPI**搭建后端接口，**Vue/React**搭建前端页面，实现：
     - 复盘报告查询（按日期、周期）；
     - 自定义参数配置（如压力线计算起点、指标参数）；
     - 交互式可视化图表（拖拽、缩放、切换周期）；
     - 消息推送（如强多头信号生成后，通过微信/邮件推送）。

4. **多标的扩展**
   - 从单一指数（上证指数）扩展到**个股、ETF、行业指数**，只需修改数据采集接口和标的列表，实现全市场标的的智能化复盘。

5. **回测系统集成**
   - 集成**Backtrader**或**聚宽JoinQuant**回测框架，对复盘生成的操作建议进行历史回测，验证规则的有效性，优化仓位和止盈止损策略。

# 四、关键技术要点（开发避坑指南）
1. **数据一致性**
   - 不同周期的K线数据（如周线、月线）必须基于日线数据聚合生成，避免直接使用第三方接口的周/月线数据（可能存在数据对齐问题）。
   - 技术指标的计算参数（如MACD的12/26/9，RSI的14）必须保持一致，确保历史数据的可比性。

2. **规则可解释性**
   - 作为价值投资+定投策略的使用者，系统的信号必须**可解释**，避免使用黑盒模型（如深度学习）作为核心决策依据。机器学习模型仅作为辅助工具，增强信号的胜率。

3. **异常处理**
   - 数据采集时，处理接口超时、数据缺失、格式错误等异常；
   - 指标计算时，处理除零错误、空值（如上市初期的均线数据）；
   - 信号生成时，处理极端市场情况（如涨停跌停、流动性枯竭）。

4. **扩展性设计**
   - 采用**接口化设计**，每层功能通过接口暴露，新增功能时只需实现接口，无需修改现有代码。
   - 示例：数据层定义`DataProvider`接口，Tushare、Wind、聚宽等数据源分别实现该接口，系统可动态切换数据源。

# 五、工具链推荐（基于软件开发人员习惯）
| 功能模块 | 工具/框架 | 优势 |
|----------|-----------|------|
| 数据采集 | Tushare/akshare | 免费、API友好、文档齐全 |
| 数据处理 | Pandas/Numpy | 高效的数值计算和数据清洗 |
| 技术指标 | TA-Lib/Backtrader | 内置大量技术指标，无需重复开发 |
| 模板引擎 | Jinja2 | 轻量级、易集成、支持Markdown/HTML |
| 可视化 | Plotly/Matplotlib | Plotly生成交互式图表，Matplotlib适合静态图 |
| 定时任务 | APScheduler/Airflow | APScheduler轻量级，Airflow适合分布式任务 |
| 后端接口 | FastAPI | 高性能、自动生成API文档、支持异步 |
| 前端框架 | Vue/React | 生态丰富、组件化开发、易上手 |
| 数据库 | SQLite/PostgreSQL | SQLite适合MVP，PostgreSQL适合全功能系统 |

从**指数级多周期共振分析**，迁移到**个股级定期复盘**，核心逻辑**完全通用**，但需要**针对个股特性做3个关键调整**：
1.  指数的“长期趋势线”替换为个股的“基本面锚定（如估值、业绩）+ 技术趋势线”
2.  增加**个股独有的维度**（如行业地位、主力资金、事件驱动）
3.  多周期共振的“信号权重”向**基本面周期（如季度业绩、年度财报）** 倾斜

作为价值投资+定投的实践者，个股复盘的核心目标是：**判断“技术走势是否与基本面匹配”，验证“当前价格是否处于合理估值区间”，从而决定定投的加仓/减仓/持有节奏**。

以下是**个股智能化复盘框架**，完全复用你即将开发的指数分析系统的技术架构（数据采集→指标计算→信号生成→报告输出），只需新增个股专属模块：

# 一、个股复盘与指数复盘的核心差异（关键调整点）
| 维度 | 指数复盘 | 个股复盘 | 技术实现调整 |
|------|----------|----------|--------------|
| **核心锚定** | 长期趋势线（如6124-5178）+ 宏观政策 | **基本面锚定**（PE/PB分位、业绩增速）+ **技术趋势线**（历史高低点、筹码峰） | 新增**估值计算模块**+**筹码分析模块** |
| **多周期维度** | 日/周/月/年线（纯技术周期） | 技术周期（日/周/月）+ **基本面周期**（季度/年度财报） | 新增**业绩周期信号模块** |
| **资金面** | 北向、两融、公募（全市场资金） | 北向持仓变化、**主力资金（龙虎榜）**、**股东人数变化** | 新增**个股资金流向采集模块** |
| **驱动因子** | 宏观经济、政策 | 行业景气度、**个股事件（定增、回购、业绩预告）**、公司治理 | 新增**事件驱动因子库** |
| **风险因子** | 市场系统性风险 | 系统性风险 + **个股非系统性风险**（业绩暴雷、行业政策、商誉减值） | 新增**风险预警规则** |

# 二、个股智能化复盘的核心模块（复用指数系统架构）
整个系统的技术架构不变，只需在**数据层、计算层、信号层**新增个股专属逻辑，以下是核心模块的设计：

## 1. 数据层：个股专属数据采集（新增模块）
在指数数据采集的基础上，新增以下个股专属数据，推荐数据源：
- **基础数据**：个股K线、分红送转、复权因子（Tushare/akshare）
- **基本面数据**：财务报表（利润表、资产负债表）、PE/PB/PS估值、业绩预告/快报（Tushare/Wind）
- **资金数据**：北向资金持仓（每日/季度）、龙虎榜数据、股东人数变化（东方财富网/同花顺API）
- **事件数据**：公司公告（定增、回购、减持、诉讼）、行业政策、产品涨价（AKShare/聚宽）
- **行业数据**：行业景气度（如光伏装机量、半导体销量）、行业估值分位（Wind/行业数据库）

**核心技术点**：
- 个股需处理**复权问题**（前复权用于技术分析，后复权用于长期收益计算）
- 财务数据需**标准化处理**（如同比/环比增速、TTM滚动计算）

## 2. 计算层：个股专属指标计算（核心模块，分2类）
### （1）技术类指标（复用指数系统，调整参数）
- **趋势线**：连接个股历史高点（如上市以来高点、近3年高点）和次高点，计算当期压力线；连接历史低点和次低点，计算支撑线
- **多周期技术指标**：日线/周线/月线的MACD、RSI、均线（MA5/MA10/MA60/MA250），与指数系统完全复用代码
- **筹码指标**：新增筹码峰（成本分布）、筹码集中度（90%筹码成本区间），判断当前价格是否处于筹码密集区

### （2）基本面类指标（个股核心，新增模块）
- **估值指标**：PE-TTM、PB、PS的当前值 + 历史分位（如近5年分位、行业分位），判断是否低估/合理/高估
- **业绩指标**：营收同比增速、归母净利润同比增速、ROE（加权）、净利润率，判断业绩增长的持续性
- **现金流指标**：经营活动现金流净额、现金流/净利润比，验证业绩的真实性
- **行业对比指标**：个股业绩增速 vs 行业平均增速、个股估值 vs 行业估值，判断行业地位

**核心代码示例**（估值分位计算）：
```python
def calculate_valuation_quantile(pe_series, current_pe):
    """
    pe_series: 个股近5年的PE-TTM序列（已排序）
    current_pe: 当前PE-TTM
    return: 估值分位（0-100%），估值判断（低估/合理/高估）
    """
    quantile = (pe_series < current_pe).sum() / len(pe_series) * 100
    if quantile < 30:
        return quantile, "低估"
    elif quantile < 70:
        return quantile, "合理"
    else:
        return quantile, "高估"
```

## 3. 信号层：个股多维度共振信号生成（核心逻辑）
个股的核心信号是**“技术面+基本面+资金面+事件面”的四维共振**，通过评分系统量化信号强度，**基本面信号权重最高**（符合价值投资逻辑）。

### （1）信号权重配置（可配置化，JSON管理）
```json
{
    "fundamental": {  // 权重最高，价值投资核心
        "valuation_low": 3,
        "earnings_growth": 3,
        "roe_stable": 2
    },
    "technical": {  // 验证走势与基本面匹配度
        "multi_cycle_bull": 2,
        "break_support": -2,
        "chip_concentration": 1
    },
    "capital": {  // 验证资金认可度
        "north_inflow": 1,
        "shareholder_decrease": 2,
        "main_capital_inflow": 1
    },
    "event": {  // 短期催化/风险
        "stock_repurchase": 2,
        "performance_preview": 2,
        "major_shareholder_reduction": -3
    }
}
```

### （2）核心共振信号类型（对应定投操作）
1.  **强买入信号**（定投加仓/手动加仓）：
    - 基本面：估值低估（分位<30%）+ 业绩增速>行业平均 + ROE稳定
    - 技术面：日线多头+周线多头+月线站稳MA250
    - 资金面：北向持续流入+股东人数减少
    - 事件面：无负面事件/有回购/业绩预增
2.  **持有信号**（继续定投/持有）：
    - 基本面：估值合理 + 业绩增速稳定
    - 技术面：多周期震荡 + 无破位风险
    - 资金面：资金小幅波动
    - 事件面：中性事件
3.  **减仓/止盈信号**（定投暂停/部分止盈）：
    - 基本面：估值高估（分位>70%）+ 业绩增速放缓
    - 技术面：日线空头+周线空头+跌破MA60
    - 资金面：北向持续流出+股东人数增加
    - 事件面：业绩预减/大股东减持
4.  **风险预警信号**（清仓/规避）：
    - 基本面：业绩暴雷（净利润同比下滑>50%）+ 现金流为负
    - 技术面：跌破历史支撑位+放量下跌
    - 事件面：诉讼/监管处罚/商誉减值

### （3）技术实现：信号叠加与评分
完全复用指数系统的共振评分逻辑，只需将评分规则替换为个股的权重配置，最终输出**总评分+信号类型+对应操作建议**。

## 4. 输出层：个股复盘报告与可视化（复用指数系统）
报告模板新增个股专属章节，可视化新增**估值分位图、业绩增速对比图、筹码分布图**。

### （1）报告核心章节（Markdown/HTML）
1.  基础信息（股票代码/名称、复盘日期、当前价格/涨跌幅）
2.  基本面分析（估值分位、业绩增速、ROE、行业对比）
3.  技术面分析（多周期信号、压力/支撑位、筹码分布）
4.  资金面分析（北向持仓、股东人数、主力资金）
5.  事件面分析（近期公告、行业政策）
6.  共振信号与评分（总评分、信号类型）
7.  操作建议（定投加仓/持有/减仓/止盈）
8.  风险提示（个股非系统性风险、市场系统性风险）

### （2）可视化图表（Plotly/Matplotlib）
- 技术面：K线图（叠加压力/支撑线、均线）、MACD/RSI指标图、筹码分布图
- 基本面：估值分位走势图（PE/PB近5年分位）、业绩增速对比图（个股vs行业）
- 资金面：北向持仓变化图、股东人数变化图

# 三、个股定期复盘的频率与流程（匹配投资风格）
根据你的**价值投资+定投**风格，建议采用**“长期基本面跟踪+中短期技术面验证”**的复盘频率，避免过度交易：

| 复盘类型 | 频率 | 核心关注 | 操作触发 |
|----------|------|----------|----------|
| **日复盘** | 每日收盘后（10分钟） | 技术面（是否破位/突破）、资金面（北向是否大幅流入/流出）、事件面（是否有突发公告） | 仅触发**风险预警**（如突发利空破位，暂停定投） |
| **周复盘** | 每周日（30分钟） | 多周期技术共振、周度资金变化、行业景气度 | 触发**定投节奏调整**（如技术面多头+估值低估，增加定投金额） |
| **月复盘** | 每月最后一个交易日（1小时） | 月度业绩预告、估值分位变化、月线技术信号 | 验证**基本面与技术面匹配度** |
| **季度复盘** | 财报发布后（2小时） | 季度业绩增速、ROE、现金流、行业地位变化 | 核心**操作决策点**（如业绩不及预期，减仓；业绩超预期，加仓） |
| **年度复盘** | 年报发布后（3小时） | 年度业绩、分红率、公司战略、行业趋势 | 决定**是否继续持有该标的**（如基本面恶化，清仓换股） |

**技术实现**：通过定时任务系统，按不同频率触发不同深度的复盘逻辑（日复盘仅运行技术面+事件面模块，季度复盘运行全模块）。

# 四、关键技术要点（个股复盘避坑指南）
1.  **复权一致性**：所有技术分析必须使用**前复权数据**，避免分红送转导致的K线跳空，影响趋势判断。
2.  **估值指标的选择**：不同行业适用不同估值指标（如消费股看PE，银行股看PB，成长股看PS），需在系统中为每个行业配置**默认估值指标**，支持手动切换。
3.  **基本面周期与技术周期的匹配**：价值投资的核心是“基本面领先技术面”，如果出现“估值低估但技术面持续走弱”，需排查是否存在**未被市场定价的基本面风险**（如业绩即将暴雷），而非盲目加仓。
4.  **非系统性风险的量化**：个股的非系统性风险（如诉讼、减持）难以量化，可通过**事件权重配置**（如大股东减持权重-3），将定性事件转化为定量评分，纳入共振信号。
5.  **系统的可扩展性**：支持**自定义行业逻辑**（如新能源行业的“装机量”指标、半导体行业的“产能”指标），通过配置文件新增行业专属因子，无需修改核心代码。

# 五、与指数复盘系统的协同效应
你可以将**个股复盘系统**与**指数复盘系统**设计为**同一平台下的两个模块**，实现以下协同效应：
1.  **市场环境判断**：指数复盘的共振信号（如强多头）为个股操作提供**市场环境参考**（牛市中可适当提高仓位，熊市中严格控制仓位）
2.  **行业轮动参考**：通过行业指数的复盘信号（如半导体行业指数强多头），优先选择该行业内的优质个股
3.  **风险对冲**：当指数复盘发出**系统性风险预警**时，无论个股信号如何，均统一减仓/暂停定投
4.  **数据复用**：宏观经济数据、行业数据、资金面数据（如北向资金）在两个系统中复用，减少数据采集成本

### 一、 指数+个股复盘系统协同架构图（分层架构，模块复用）
采用**核心层复用+业务层差异化**设计，最大化代码复用率，同时满足指数与个股的独特分析需求。

```
┌─────────────────────────────────────────────────────────────────┐
│ 交互层（统一入口）                                              │
│  ├─ 定时任务模块（APScheduler/Airflow）                          │
│  │  ├─ 指数复盘：日/周/月/年频触发                              │
│  │  └─ 个股复盘：日/周/月/季度/年频触发（差异化频率）            │
│  ├─ API接口模块（FastAPI）                                       │
│  │  ├─ 通用接口：报告查询、信号查询、可视化渲染                  │
│  │  ├─ 指数专属接口：趋势线计算、市场资金流向查询                │
│  │  └─ 个股专属接口：估值分位查询、股东人数变化查询              │
│  └─ 前端页面（Vue/React）                                        │
│     ├─ 统一布局：数据概览、信号中心、操作建议                    │
│     ├─ 指数复盘页：多周期共振、市场风险因子                      │
│     └─ 个股复盘页：基本面锚定、筹码分布、事件驱动                │
├─────────────────────────────────────────────────────────────────┤
│ 输出层（统一渲染，差异化模板）                                   │
│  ├─ 报告生成模块（Jinja2）                                       │
│  │  ├─ 通用模板：基础信息、信号评分、操作建议                    │
│  │  ├─ 指数报告模板：趋势线分析、市场资金面、宏观政策            │
│  │  └─ 个股报告模板：估值分析、业绩周期、事件驱动、行业对比      │
│  └─ 可视化模块（Plotly/Matplotlib）                              │
│     ├─ 通用图表：K线图、MACD/RSI指标图、共振评分图              │
│     ├─ 指数专属图表：市场资金流向图、多指数对比图                │
│     └─ 个股专属图表：估值分位图、筹码分布图、业绩增速对比图      │
├─────────────────────────────────────────────────────────────────┤
│ 信号层（核心逻辑，差异化规则配置）                               │
│  ├─ 共振评分模块（通用引擎）                                     │
│  │  ├─ 通用逻辑：多维度信号加权求和、信号强度判定（强/中/弱）    │
│  │  ├─ 指数评分规则：多周期技术（权重60%）+市场资金（30%）+宏观（10%）│
│  │  └─ 个股评分规则：基本面（50%）+技术（20%）+资金（20%）+事件（10%）│
│  ├─ 信号生成模块（差异化因子）                                   │
│  │  ├─ 通用信号：多周期技术信号（多头/空头/震荡）                │
│  │  ├─ 指数专属信号：趋势线突破信号、市场系统性风险信号          │
│  │  └─ 个股专属信号：估值低估/高估信号、业绩预增/减信号、事件驱动信号│
│  └─ 风险预警模块（差异化风险因子）                               │
│     ├─ 通用风险：市场波动风险                                    │
│     ├─ 指数专属风险：政策转向风险、外资大幅流出风险              │
│     └─ 个股专属风险：业绩暴雷风险、大股东减持风险、行业政策风险  │
├─────────────────────────────────────────────────────────────────┤
│ 计算层（核心算法复用，差异化指标扩展）                           │
│  ├─ 技术指标计算模块（通用算法）                                 │
│  │  ├─ 通用指标：MACD、RSI、均线、趋势线计算                    │
│  │  └─ 个股扩展指标：筹码峰、筹码集中度                          │
│  ├─ 估值计算模块（个股专属）                                     │
│  │  ├─ 估值指标：PE-TTM、PB、PS、股息率                          │
│  │  └─ 分位计算：历史分位、行业分位                              │
│  ├─ 业绩计算模块（个股专属）                                     │
│  │  ├─ 业绩指标：营收增速、净利润增速、ROE、现金流净额            │
│  │  └─ 对比分析：个股vs行业平均、同比vs环比                      │
│  └─ 评分规则管理模块（通用配置引擎）                             │
│     ├─ 规则存储：JSON配置文件/数据库                            │
│     └─ 规则加载：动态加载指数/个股评分规则                      │
├─────────────────────────────────────────────────────────────────┤
│ 数据层（统一采集接口，差异化数据源）                             │
│  ├─ 数据采集模块（通用接口化设计）                               │
│  │  ├─ 通用数据源：Tushare/akshare（K线、资金流向）              │
│  │  ├─ 指数专属数据源：宏观经济数据（PMI、GDP）、政策公告        │
│  │  └─ 个股专属数据源：财务报表、股东人数、龙虎榜、公司公告      │
│  ├─ 数据清洗模块（差异化处理）                                   │
│  │  ├─ 通用清洗：缺失值填充、格式标准化                          │
│  │  ├─ 指数数据清洗：多指数数据对齐                              │
│  │  └─ 个股数据清洗：复权处理、财务数据TTM滚动计算              │
│  └─ 数据存储模块（统一存储，差异化表结构）                       │
│     ├─ 通用存储：K线表、指标表、信号表                          │
│     ├─ 指数专属表：市场资金表、宏观政策表                        │
│     └─ 个股专属表：财务数据表、估值分位表、事件驱动表            │
└─────────────────────────────────────────────────────────────────┘
```

### 二、 个股专属信号权重配置JSON模板（可直接用于系统）
权重设计**向基本面倾斜**，符合价值投资逻辑，支持动态调整。
```json
{
  "signal_weight_config": {
    "template_name": "价值投资型个股复盘权重",
    "update_time": "2026-01-03",
    "total_weight": 10,
    "weight_distribution": {
      "fundamental": {
        "weight_ratio": 5,
        "factors": [
          {
            "factor_name": "valuation_low",
            "display_name": "估值低估（分位<30%）",
            "weight": 2,
            "condition": "valuation_quantile < 30 and valuation_status == '低估'"
          },
          {
            "factor_name": "earnings_growth",
            "display_name": "业绩增速超行业",
            "weight": 2,
            "condition": "net_profit_growth > industry_avg_growth and net_profit_growth > 0"
          },
          {
            "factor_name": "roe_stable",
            "display_name": "ROE稳定（波动<10%）",
            "weight": 1,
            "condition": "roe_volatility < 10 and roe > industry_avg_roe"
          }
        ]
      },
      "technical": {
        "weight_ratio": 2,
        "factors": [
          {
            "factor_name": "multi_cycle_bull",
            "display_name": "日+周+月线多头共振",
            "weight": 1,
            "condition": "daily_signal == 1 and weekly_signal == 1 and monthly_signal == 1"
          },
          {
            "factor_name": "chip_concentration",
            "display_name": "筹码集中度高（90%筹码区间窄）",
            "weight": 1,
            "condition": "chip_90_range < 10 and current_price > chip_90_avg"
          }
        ]
      },
      "capital": {
        "weight_ratio": 2,
        "factors": [
          {
            "factor_name": "north_inflow",
            "display_name": "北向资金连续3日流入",
            "weight": 1,
            "condition": "north_money_trend == '连续流入' and inflow_days >= 3"
          },
          {
            "factor_name": "shareholder_decrease",
            "display_name": "股东人数连续2期减少",
            "weight": 1,
            "condition": "shareholder_count_trend == '连续减少' and decrease_periods >= 2"
          }
        ]
      },
      "event": {
        "weight_ratio": 1,
        "factors": [
          {
            "factor_name": "stock_repurchase",
            "display_name": "公司回购股份",
            "weight": 1,
            "condition": "event_type == '回购' and repurchase_amount > 0"
          },
          {
            "factor_name": "major_shareholder_reduction",
            "display_name": "大股东减持（负面）",
            "weight": -1,
            "condition": "event_type == '减持' and reduction_ratio > 1"
          }
        ]
      }
    },
    "signal_strength_rule": {
      "strong_buy": {
        "min_score": 7,
        "operation_suggestion": "定投加仓/手动加仓"
      },
      "hold": {
        "min_score": 3,
        "max_score": 6,
        "operation_suggestion": "继续定投/持有"
      },
      "reduce": {
        "min_score": -2,
        "max_score": 2,
        "operation_suggestion": "定投暂停/部分止盈"
      },
      "sell": {
        "max_score": -3,
        "operation_suggestion": "清仓/规避"
      }
    }
  }
}
```

### 三、 估值分位计算核心代码（Python，可直接集成到计算层）
支持**历史分位**和**行业分位**计算，自动适配不同行业的估值指标（如消费股PE、银行股PB）。
```python
import pandas as pd
import numpy as np

def calculate_valuation_quantile(
    valuation_series: pd.Series,
    current_valuation: float,
    industry_valuation_series: pd.Series = None,
    valuation_type: str = "PE-TTM"
) -> dict:
    """
    计算个股估值的历史分位和行业分位
    :param valuation_series: 个股近N年的估值序列（如PE-TTM，已去极值）
    :param current_valuation: 当前估值值
    :param industry_valuation_series: 行业内所有个股的当前估值序列（可选）
    :param valuation_type: 估值类型，用于判断合理区间（PE-TTM/PB/PS）
    :return: 估值分位结果字典
    """
    # 1. 历史分位计算（核心）
    # 去极值处理（避免异常值影响分位）
    q1 = valuation_series.quantile(0.25)
    q3 = valuation_series.quantile(0.75)
    iqr = q3 - q1
    lower_bound = q1 - 1.5 * iqr
    upper_bound = q3 + 1.5 * iqr
    filtered_series = valuation_series[
        (valuation_series >= lower_bound) & (valuation_series <= upper_bound)
    ]
    
    # 计算历史分位（0-100%）
    history_quantile = (filtered_series < current_valuation).sum() / len(filtered_series) * 100
    history_quantile = round(history_quantile, 2)
    
    # 历史估值状态判断
    if history_quantile < 30:
        history_status = "低估"
    elif history_quantile < 70:
        history_status = "合理"
    else:
        history_status = "高估"
    
    # 2. 行业分位计算（可选）
    industry_quantile = None
    industry_status = None
    if industry_valuation_series is not None and not industry_valuation_series.empty:
        industry_quantile = (industry_valuation_series < current_valuation).sum() / len(industry_valuation_series) * 100
        industry_quantile = round(industry_quantile, 2)
        if industry_quantile < 30:
            industry_status = "行业内低估"
        elif industry_quantile < 70:
            industry_status = "行业内合理"
        else:
            industry_status = "行业内高估"
    
    # 3. 估值合理性补充判断（不同估值类型的特殊逻辑）
    rationality_note = ""
    if valuation_type == "PE-TTM" and current_valuation < 10:
        rationality_note = "PE低于10，估值处于历史极低区间，需关注业绩是否存在暴雷风险"
    elif valuation_type == "PB" and current_valuation < 0.8:
        rationality_note = "PB低于0.8，处于破净状态，需关注公司资产质量"
    
    # 4. 组装结果
    result = {
        "valuation_type": valuation_type,
        "current_valuation": round(current_valuation, 2),
        "history_quantile": history_quantile,
        "history_status": history_status,
        "industry_quantile": industry_quantile,
        "industry_status": industry_status,
        "rationality_note": rationality_note
    }
    
    return result

# 【使用示例】
if __name__ == "__main__":
    # 模拟个股近5年PE-TTM序列
    stock_pe_series = pd.Series([15, 18, 22, 16, 20, 14, 17, 19, 21, 13])
    # 当前PE-TTM
    current_pe = 14.5
    # 模拟行业当前PE-TTM序列
    industry_pe_series = pd.Series([16, 18, 20, 15, 17, 22, 19, 14, 13, 21])
    
    # 计算估值分位
    valuation_result = calculate_valuation_quantile(
        valuation_series=stock_pe_series,
        current_valuation=current_pe,
        industry_valuation_series=industry_pe_series,
        valuation_type="PE-TTM"
    )
    
    print(valuation_result)
    # 输出示例：
    # {
    #     "valuation_type": "PE-TTM",
    #     "current_valuation": 14.5,
    #     "history_quantile": 30.0,
    #     "history_status": "合理",
    #     "industry_quantile": 30.0,
    #     "industry_status": "行业内合理",
    #     "rationality_note": ""
    # }
```